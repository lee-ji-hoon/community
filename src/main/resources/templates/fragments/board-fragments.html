<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security" xmlns="http://www.w3.org/1999/html">
<body>
    <script th:fragment="s3-board-image-upload(uploadUrl)">
    $(document).ready(function () {
        $("#input_file").on("change", fileCheck);
    });
    $(function () {
        $('#btn-upload').click(function (e) {
            e.preventDefault();
            $('#input_file').click();
        });
    });

    // 파일 현재 필드 숫자 totalCount랑 비교값
    let fileCount = 0;
    // 해당 숫자를 수정하여 전체 업로드 갯수를 정한다.
    const totalCount = 6;
    // 파일 고유넘버
    let fileNum = 0;
    // 첨부파일 배열
    const content_files = new Array();
    // 이미지
    let imageFileDict = {};

    function fileCheck(e) {

        const files = e.target.files;

        // 파일 배열 담기
        const filesArr = Array.prototype.slice.call(files);

        if (fileCount + filesArr.length > totalCount) {
            alert('이미지는 최대 '+totalCount+'개까지 업로드 할 수 있습니다.');
            return;
        } else {
            fileCount = fileCount + filesArr.length;
        }

        // 각각의 파일 배열담기 및 기타
        filesArr.forEach(function (f) {
            const reader = new FileReader();
            reader.onload = function (e) {
                imageFileDict[fileNum] = files;
                content_files.push(f);
                $('#articlefileChange').append(
                    '<div class="mx-1" id="file' + fileNum + '" onclick="fileDelete(\'file' + fileNum + '\')">' +
                    '<button> 삭제 </button>' +
                    `<img src="${e.target.result}" data-file=${f.name} className="article-image" style="width: 150px; height: 200px"/>` +
                    '</div>'
                );
                fileNum ++;
            };
            reader.readAsDataURL(f);
        });
        //초기화 한다.
        $("#input_file").val("");
    }

    // 파일 부분 삭제 함수
    function fileDelete(fileNum){
        var no = fileNum.replace(/[^0-9]/g, "");
        content_files[no].is_delete = true;
        $('#' + fileNum).remove();
        fileCount --;
    }

    document.board_form.addEventListener("keydown", evt => {
        if (evt.code === "Enter") evt.preventDefault();
    });
    document.imageDelete.addEventListener("keydown", evt => {
        if (evt.code === "Enter") evt.preventDefault();
    });
    function updateProject(e) {
        const form = $("form")[0];
        const formData = new FormData(form);

        formData.append("boardTitle", $('#boardTitle').val());
        formData.append("subBoardTitle", $('#subBoardTitle').val());
        formData.append("title", $('#title').val());
        formData.append("subTitle", $('#subTitle').val());
        formData.append("content", $("#content").val());
        
        for (let x = 0; x < content_files.length; x++) {
            // 삭제 안한것만 담아 준다.
            if (!content_files[x].is_delete) {
                formData.append("article_file", content_files[x]);
            }
        }
        /*
        * 파일업로드 multiple ajax처리
        */
        $.ajax({
            type: "POST",
            enctype: "multipart/form-data",
            url: "[(${uploadUrl})]",
            processData: false,
            contentType: false,
            data: formData,
            success: function () {
                location.reload();
            },
            error: function (xhr, status, error) {
                alert("작성한 내용들을 다시 확인해주세요.")
            }
        });
        return false;
    }

    function registerAction(e) {

        const form = $("form")[0];
        const formData = new FormData(form);

        formData.append("boardTitle", $('#boardTitle').val());
        formData.append("subBoardTitle", $('#subBoardTitle').val());
        formData.append("title", $('#title').val());
        formData.append("subTitle", $('#subTitle').val());
        formData.append("content", $("#content").val());

        for (let x = 0; x < content_files.length; x++) {
            // 삭제 안한것만 담아 준다.
            if (!content_files[x].is_delete) {
                formData.append("article_file", content_files[x]);
            }
        }
        /*
        * 파일업로드 multiple ajax처리
        */
        $.ajax({
            type: "POST",
            enctype: "multipart/form-data",
            url: "[(${uploadUrl})]",
            processData: false,
            contentType: false,
            data: formData,
            success: function (path) {
                location.href = "/board/detail/" + path;
            },
            error: function (xhr, status, error) {
                alert("작성한 내용들을 다시 확인해주세요." + error)
            }
        });
        return false;
    }
</script>
</body>
</html>