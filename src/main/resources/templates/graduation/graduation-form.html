<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org">
<head th:replace="theme-fragments.html :: head"></head>
<body>

<div id="wrapper">

    <!-- Header -->
    <header th:replace="theme-fragments.html :: header"></header>

    <!-- sidebar -->
    <div th:replace="theme-fragments.html :: side_bar(currentSideMenu='graduation')"></div>

    <!-- Main Contents -->
    <div class="main_content">
        <form class="needs-validation col-sm-10"
              name="graduationForm" id="graduationForm"
              onsubmit="return false"
              novalidate enctype="multipart/form-data">

            <div class="mcontainer">
                <div class="breadcrumb-area py-0">
                    <div class="breadcrumb">
                        <ul class="m-0">
                            <li>
                                <a th:href="@{/graduation}">졸업작품</a>
                            </li>
                            <li>
                                <a style="font-weight: bold" href="#">졸업작품 추가 </a>
                            </li>
                        </ul>
                    </div>
                </div>

                <hr>
                <div class="grid lg:grid-cols-4 sm:grid-cols-3 mt-12 gap-8">
                    <div>
                        <h3 class="text-xl mb-2 font-semibold"> 졸업작품 소개</h3>
                        <p>졸업작품 소개를 작성해주세요.</p>
                    </div>

                    <div class="bg-white rounded-md lg:shadow-md shadow lg:col-span-3 sm:col-span-2 lg:mx-16">
                        <div class="grid grid-cols-2 gap-3 lg:p-6 p-4">
                            <div class="col-span-2">
                                <label for="title" class="font-bold"> 졸업작품 프로젝트명</label>
                                <input id="title" type="text" name="title"
                                       class="shadow-none with-border form-control"
                                       placeholder="예) unect" aria-describedby="titleHelp"
                                       required max="20">
                                <small id="titleHelp" class="form-text text-muted">
                                    20자 이내로 졸업작품 프로젝트명을 적어주세요.
                                </small>
                                <small class="invalid-feedback">팀 프로젝트명을 다시 확인해주세요.</small>
                            </div>

                            <div class="col-span-2">
                                <label for="teamName" class="font-bold"> 팀 이름</label>
                                <input id="teamName" type="text" name="teamName"
                                       class="shadow-none with-border form-control"
                                       placeholder="예) 봄" aria-describedby="teamNameHelp"
                                       required max="20">
                                <small id="teamNameHelp" class="form-text text-muted">
                                    20자 이내로 졸업작품팀 이름을 작성해주세요.
                                </small>
                                <small class="invalid-feedback">팀 이름을 다시 작성해주세요. </small>
                            </div>

                            <div class="col-span-2">
                                <label for="teamMember" class="font-bold"> 팀 멤버</label>
                                <div class="keywords-container">
                                    <div class="keyword-input-container shadow-none">
                                        <input id="teamMember" name="teamMember" type="text" class="keyword-input with-border"
                                               placeholder="본인 포함 프로젝트 팀 인원을 추가해주세요." aria-describedby="teamMemberHelp"
                                               maxlength="5"/>
                                        <button type="button" class="keyword-input-button ripple-effect">
                                            <i class="icon-feather-plus"></i></button>
                                    </div>
                                    <div class="keywords-list">
                                    </div>
                                    <div class="clearfix"></div>
                                </div>

                                <small class="invalid-feedback">팀 멤버를 다시 확인해주세요. </small>
                            </div>

                            <div class="col-span-2">
                                <label for="path" class="font-bold"> 졸업작품 링크(주소)</label>
                                <input id="path" type="text" name="path"
                                       class="shadow-none with-border form-control"
                                       placeholder="프로젝트 접근 주소(링크)를 작성해주세요." aria-describedby="pathHelp"
                                       required max="100">
                                <small id="pathHelp" class="form-text text-muted">
                                    졸업작품 링크나 주소를 적어주세요
                                </small>
                                <small class="invalid-feedback">주소를 다시 작성해주세요. </small>
                            </div>

                            <div>
                                <label for="graduationType" class="font-bold"> 졸업작품 전시 종류</label>

                                <select id="graduationType" name="graduationType"
                                        class="selectpicker form-control"
                                        aria-describedby="graduationTypeHelp" required>
                                    <option class="" value="WEB" selected>웹</option>
                                    <option class="" value="MOBILE">모바일</option>
                                    <option class="" value="VIDEO">영상</option>
                                    <option class="" value="VR_AR">VR/AR</option>
                                </select>
                                <small id="studyMethodHelp" class="form-text text-muted">
                                    웹 / 모바일 / 영상 / VR/AR 중에 선택해주세요.
                                </small>
                                <small class="invalid-feedback">졸업작품 종목을 다시 선택해주세요.</small>
                            </div>
                            <div>
                                <label for="graduationDate" class="font-bold">졸업작품 연도</label>
                                <select id="graduationDate" name="graduationDate"
                                        class="selectpicker form-control"
                                        aria-describedby="graduationDateHelp" required>
                                    <option th:each="date : ${#numbers.sequence(10, 30)}" th:value="${date}" th:text="'20'+${date}+'년'"></option>
                                </select>
                                <small id="graduationDateHelp" class="form-text text-muted">
                                    졸업작품을 전시한 연도를 선택해주세요.
                                </small>
                                <small class="invalid-feedback"> 연도를 다시 확인해주세요..</small>
                            </div>

                            <div class="col-span-2">
                                <label for="description" class="font-bold"> 프로젝트 설명</label>
                                <textarea id="description" type="textarea" name="description"
                                          class="shadow-none with-border p-3 form-control"
                                          placeholder="졸업작품을 자세히 설명해 주세요." aria-describedby="fullDescriptionHelp"
                                          required>
                                </textarea>

                                <small id="descriptionHelp" class="form-text text-muted"></small>
                                <small class="invalid-feedback">설명을 다시 작성해주세요. </small>
                            </div>

                            <div class="col-span-2">
                                <div uk-form-custom class="w-full py-3">
                                    <div class="bg-gray-100 border-2 border-dashed flex flex-col h-32 items-center justify-center relative w-full rounded-lg dark:bg-gray-800 dark:border-gray-600">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-12">
                                            <path d="M5.5 13a3.5 3.5 0 01-.369-6.98 4 4 0 117.753-1.977A4.5 4.5 0 1113.5 13H11V9.413l1.293 1.293a1 1 0 001.414-1.414l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13H5.5z" />
                                            <path d="M9 13h2v5a1 1 0 11-2 0v-5z" />
                                        </svg>
                                    </div>
                                    <input id="input_file" multiple="multiple" type="file" accept="image/png, image/jpeg">
                                </div>

                                <span class="text-gray-500 text-xs">※첨부파일은 최대 5개까지 등록이 가능합니다.</span>
                            </div>

                            <div class="col-span-2">
                                <br />
                                <div class="grid sm:grid-cols-5 grid-cols-2" id="articlefileChange">
                                </div>
                            </div>

                        </div>
                        <div class="bg-gray-10 p-3 flex justify-end space-x-1">
                            <button type="reset" class="p-2 px-4 rounded bg-red-600 text-white"> 취소 </button>
                            <button type="submit" onclick="registerAction()" class="button bg-blue-600" > 저장 </button>
                        </div>
                    </div>

                </div>
            </div>
        </form>
    </div>
</div>

<script th:replace="theme-fragments.html :: form-validation"></script>
<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.css" rel="stylesheet">

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.js"></script>
<script src="/assets/js/summernote-ko-KR.js"></script>
<script src="/assets/css/summernote.min.css"></script>
<script src="/assets/js/summernote.min.js"></script>



<script type="application/javascript">
    let memberArray = [];

    $(document).ready(function() {
        //여기 아래 부분
        $('#description').summernote({
            height: 300,                 // 에디터 높이
            minHeight: null,             // 최소 높이
            maxHeight: null,             // 최대 높이
            lang: "ko-KR",					// 한글 설정
            placeholder: '졸업작품에 관련해서 최대한 자세히 작성해주세요.', //placeholder 설정
            toolbar: [
                ['font', ['bold', 'italic', 'underline', 'clear']],
            ],
        });

        $(".keywords-container").each(function() {
            // 키워드 시작
            const keywordInput = $(this).find(".keyword-input");
            const keywordsList = $(this).find(".keywords-list");
            // 태그 추가
            function addKeyword() {
                var $newKeyword = $("" +
                    "<span class='keyword'>" +
                    "<span class='keyword-remove'></span>" +
                    `<span class='keyword-text' value=${keywordInput.val()}>${keywordInput.val()}</span>` +
                    "</span>");
                keywordsList.append($newKeyword).trigger('resizeContainer');
                memberArray.push(keywordInput.val());
                keywordInput.val("");
            }

            // 태그 추가 엔터
            keywordInput.on('keyup', function(e){
                if((e.keyCode == 13) && (keywordInput.val()!=="")){
                    addKeyword();
                }
            });

            // 태그 추가 버튼
            $('.keyword-input-button').on('click', function(){
                if((keywordInput.val()!=="")){
                    addKeyword();
                }
            });

            // 태그 지우기
            $(document).on("click",".keyword-remove", function(){
                $(this).parent().addClass('keyword-removed');

                function removeFromMarkup(){
                    let value = $(".keyword-removed").remove().text();
                    memberArray = memberArray.filter(function(item) {
                        return item !== value;
                    });
                }
                setTimeout(removeFromMarkup, 500);
                keywordsList.css({'height':'auto'}).height();
            });

            keywordsList.on('resizeContainer', function(){
                var heightnow = $(this).height();
                var heightfull = $(this).css({'max-height':'auto', 'height':'auto'}).height();

                $(this).css({ 'height' : heightnow }).animate({ 'height': heightfull }, 200);
            });

            $(window).on('resize', function() {
                keywordsList.css({'height':'auto'}).height();
            });

            $(window).on('load', function() {
                var keywordCount = $('.keywords-list').children("span").length;

                if (keywordCount > 0) {
                    keywordsList.css({'height':'auto'}).height();

                }
            });
            // 키워드 끝

        });
        // input file 파일 첨부시 fileCheck 함수 실행
        $("#input_file").on("change", fileCheck);


    });

    $(function () {
        $('#btn-upload').click(function (e) {
            e.preventDefault();
            $('#input_file').click();
        });
    });

    // 파일 현재 필드 숫자 totalCount랑 비교값
    let fileCount = 0;
    // 해당 숫자를 수정하여 전체 업로드 갯수를 정한다.
    const totalCount = 10;
    // 파일 고유넘버
    let fileNum = 0;
    // 첨부파일 배열
    const content_files = new Array();
    // 이미지
    let imageFileDict = {};

    function fileCheck(e) {
        const files = e.target.files;

        // 파일 배열 담기
        const filesArr = Array.prototype.slice.call(files);

        if (fileCount + filesArr.length > totalCount) {
            alert('이미지는 최대 '+totalCount+'개까지 업로드 할 수 있습니다.');
            return;
        } else {
            fileCount = fileCount + filesArr.length;
        }

        // 각각의 파일 배열담기 및 기타
        filesArr.forEach(function (f) {
            const reader = new FileReader();
            reader.onload = function (e) {
                imageFileDict[fileNum] = files;
                content_files.push(f);
                $('#articlefileChange').append(
                    '<div class="mx-1" id="file' + fileNum + '" onclick="fileDelete(\'file' + fileNum + '\')">' +
                    '<button> 삭제 </button>' +
                    `<img src="${e.target.result}" data-file=${f.name} className="article-image" style="width: 150px; height: 150px"/>` +
                    '</div>'
                );
                fileNum ++;
            };
            reader.readAsDataURL(f);
        });
        //초기화 한다.
        $("#input_file").val("");
    }

    // 파일 부분 삭제 함수
    function fileDelete(fileNum){
        var no = fileNum.replace(/[^0-9]/g, "");
        content_files[no].is_delete = true;
        $('#' + fileNum).remove();
        fileCount --;
    }

    document.graduationForm.addEventListener("keydown", evt => {
        if (evt.code === "Enter") evt.preventDefault();
    });

    function registerAction(e) {

        const form = $("form")[0];
        const formData = new FormData(form);

        if (memberArray.length > 4) {
            alert("인원은 4명까지만 등록 가능합니다.");
            return;
        }

        if (memberArray.length === 0) {
            alert("본인 포함 팀장과 팀원들을 적어주시기 바랍니다.")
            return;
        }

        formData.append("teamMember", memberArray);
        formData.append("title", $('#title').val());
        formData.append("teamName", $('#teamName').val());
        formData.append("path", $('#path').val());
        formData.append("graduationType", $('#graduationType').val());
        formData.append("graduationDate", $("#graduationDate").val())
        formData.append("description", $('#description').val());

        if (content_files.length === 0) {
            alert('이미지는 최소 1개 이상 업로드해야 합니다.');
            return;
        }

        for (let x = 0; x < content_files.length; x++) {
            // 삭제 안한것만 담아 준다.
            if (!content_files[x].is_delete) {
                formData.append("article_file", content_files[x]);
            }
        }
        /*
        * 파일업로드 multiple ajax처리
        */
        $.ajax({
            type: "POST",
            enctype: "multipart/form-data",
            url: "/graduation-new",
            processData: false,
            contentType: false,
            data: formData,
            success: function (path) {
                location.href = "/graduation/" + path;
            },
            error: function (xhr, status, error) {
                alert("작성한 내용들을 다시 확인해주세요.")
            }
        });
        return false;
    }



</script>
</body>
</html>