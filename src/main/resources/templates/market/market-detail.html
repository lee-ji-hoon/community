<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org">
<head th:replace="theme-fragments.html :: head"></head>
<style>
    .updateSubmit{
        display: none;
    }

    #deleteBtn:hover {
        color: #EF4444;
    }
</style>
<body>

<div id="wrapper">

    <!-- Header -->
    <header th:replace="theme-fragments.html :: header"></header>

    <!-- sidebar -->
    <div th:replace="theme-fragments.html :: side_bar(currentSideMenu='market')"></div>

    <!-- Main Contents -->
    <div class="main_content">
        <div class="mcontainer">
            <div th:replace="theme-fragments.html :: checked-email"></div>
            <div class="breadcrumb-area py-0">
                <div class="breadcrumb">
                    <ul class="m-0">
                        <li>
                            <a th:href="@{/market}">장터</a>
                        </li>
                        <li>
                            <a style="font-weight: bold" href="#"> 상세보기</a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="lg:flex lg:space-x-10">
                <div class="lg:w-3/4 lg:px-20 space-y-7">
                    <div id="notice-alarm" class="notice-alarm" style="display: none">
                        <div th:replace="theme-fragments.html :: blue-notice(message = '수정됐습니다.')"></div>
                    </div>
                    <div class="form_refresh">
                        <div class="card lg:mx-0 uk-animation-slide-bottom-small">
                            <!-- post header-->
                            <div class="flex justify-between items-center lg:p-4 p-2.5">
                                <div class="flex flex-1 items-center space-x-4">
                                    <a href="#">
                                        <img th:if="${#strings.isEmpty(product.seller.profileImage)}"
                                             th:data-id="${product.seller.studentId}"
                                             class="identicon border border-white rounded-full w-10 h-10"/>
                                        <img th:if="${!#strings.isEmpty(product.seller.profileImage)}"
                                             th:src="${product.seller.profileImage}" alt=""
                                             class=" border border-white rounded-full w-10 h-10">
                                    </a>
                                    <div class="flex-1 font-semibold capitalize">
                                        <a href="#" class="text-black" th:text="${product.seller.nickname}"> Johnson smith </a>
                                        <div th:text="${product.marketType}" class="text-sm"></div>
                                        <span th:text="${#temporals.format(product.itemUploadTime,  'yyyy-MM-dd')}"></span>
                                    </div>
                                </div>
                                <div th:if="${account.username.equals(product.seller.username)}">
                                    <a href="#"> <i class="icon-feather-more-horizontal text-2xl hover:bg-gray-200 rounded-full p-2 transition -mr-1 dark:hover:bg-gray-700"></i> </a>
                                    <div class="bg-white w-56 shadow-md mx-auto p-2 mt-12 rounded-md text-gray-500 hidden text-base border border-gray-100 dark:bg-gray-900 dark:text-gray-100 dark:border-gray-700"
                                         uk-drop="mode: click;pos: bottom-right;animation: uk-animation-slide-bottom-small">

                                        <ul th:if="${product.itemStatus}" class="space-y-1">
                                            <li>
                                                <button
                                                   onclick="marketTypeSell()"
                                                   class="flex items-center px-3 py-2 hover:bg-gray-200 hover:text-gray-800 rounded-md dark:hover:bg-gray-800">
                                                    판매 중
                                                </button>
                                            </li>
                                            <li>
                                                <button
                                                    onclick="marketTypeEnd()"
                                                    class="flex items-center px-3 py-2 hover:bg-gray-200 hover:text-gray-800 rounded-md dark:hover:bg-gray-800">
                                                    판매 완료
                                                </button>
                                            </li>
                                            <hr/>
                                            <li>
                                                <a href="#offcanvas-create" uk-toggle
                                                   class="flex items-center px-3 py-2 hover:bg-gray-200 hover:text-gray-800 rounded-md dark:hover:bg-gray-800">
                                                    <i class="uil-edit-alt mr-1"></i> 수정
                                                </a>
                                            </li>
                                            <li>
                                                <form th:action="@{'/market/detail/'+${product.marketId}+'/delete'}"
                                                      method="POST" id="market-delete" class="flex items-center px-3 py-2 text-red-500 hover:bg-red-200 rounded-md dark:hover:bg-red-600" novalidate>
                                                    <input type="hidden" th:value="${product.filePath}" name="file" id="file">
                                                    <button id="deleteBtn" type="submit" style="" >
                                                        <i class="uil-trash-alt mr-1"></i>삭제
                                                    </button>
                                                </form>
                                            </li>
                                        </ul>

                                    </div>
                                </div>
                            </div>

                            <div class="p-4 space-y-3 relative">
                                <div class="text-2xl font-semibold pt-2" th:text="${product.itemName}"> Product title</div>
                                <p th:utext="${product.itemDetail}"> 물건 설명</p>

                                <img th:src="${product.getFilePath()}"/>
                                <!--<td th:text="|${#numbers.formatInteger(product.price, 0, 'COMMA')}원|"></td>-->
                                <div th:text="|${#numbers.formatInteger(product.price, 0, 'COMMA')}원|"
                                     class="top-3 absolute bg-gray-100 font-semibold px-3 py-1 right-3 rounded-full text text-sm">
                                    $56.99
                                </div>

                                <div class="flex space-x-3 items-center text-sm md:pt-3">
                                    <div class="flex">물건 상태 :
                                        <span th:text="${product.itemStatus}"
                                              class="font-semibold text-sm ml-1"> 상태</span>
                                    </div>

                                    <div class="flex">
                                        <span class="font-semibold text-yellow-500 mr-2" th:text="${product.marketItemStatus}">판매 중</span>
    <!--                                    <span class="font-semibold text-yellow-500 mr-2" th:text="${product.byeAndSell}">판매완료 </span>-->
                                    </div>
                                </div>
                                <th:block th:if="${product.seller != account}">
                                    <hr>

                                    <div class="grid grid-cols-2 gap-4 mb-5">

                                        <a href="#create-new-chat" uk-toggle class="bg-gray-200 flex flex-1 font-semibold h-10 items-center justify-center px-4 rounded-md">
                                            쪽지
                                        </a>
                                        <!-- Craete video post modal -->
                                        <div id="create-new-chat" uk-modal>
                                            <div class="uk-modal-dialog">
                                                <button class="uk-modal-close-default hover:bg-gray-100 rounded-full p-2.5 block uk-icon uk-close mt-0.5"
                                                        type="button" uk-close>
                                                    <i class="icon-feather-close"></i>
                                                </button>

                                                <div class="uk-modal-header">
                                                    <h3 class="text-lg font-semibold"> 쪽지 보내기 </h3>
                                                </div>
                                                <th:block th:if="${account.isEmailVerified()}">
                                                    <form class="needs-validation" id="chat_form" onsubmit="return false">
                                                        <div class="uk-modal-body" uk-overflow-auto>
                                                            <div class="space-y-4 g:w-8/12">
                                                                <div class="form-group d-none">
                                                                    <div>
                                                                        <input class="form-control bg-gray-100 p-3" type="text" id="c_attender" name="c_attender"
                                                                               th:value="${product.seller.id}" readonly/>
                                                                        <!--<input type="hidden" id="c_market_id" name="market_id" class="form-control"
                                                                               value="1" th:value="${marketId}" readonly>-->
                                                                    </div>
                                                                </div>
                                                                <!-- 본문 -->
                                                                <div class="form-group">
                                                                    <div>
                                                                <textarea class="form-control bg-gray-100 p-3"  id="c_content" name="c_content" style="resize: none"
                                                                          type="text" aria-describedby="contentHelp" required></textarea>
                                                                    </div>
                                                                    <small id="contentHelp" class="form-text text-muted">욕설이나 상대방을 비하하는 단어를 사용할 경우 경우 제재될 수 있습니다.</small>
                                                                    <small class="invalid-feedback">글을 입력해주세요.</small>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="uk-modal-footer uk-text-right">
                                                            <button class="bg-red-500 font-medium h-9 items-center justify-center px-5 rounded-md text-white py-1 uk-modal-close">취소</button>
                                                            <button class="bg-blue-600 font-medium h-9 items-center justify-center px-5 rounded-md text-white py-1 chat_send uk-modal-close">보내기</button>
                                                        </div>
                                                    </form>
                                                </th:block>
                                                <th:block th:if="${!account.isEmailVerified()}">
                                                    <div class="uk-modal-body" uk-overflow-auto>
                                                        <div class="space-y-4 g:w-8/12">
                                                            <p>아직 이메일 인증을 하지 않은 회원입니다.</p>
                                                            <p>이메일 인증 후 다시 시도해주세요.</p>
                                                        </div>
                                                    </div>
                                                    <div class="uk-modal-footer uk-text-right">
                                                        <button class="bg-red-500 font-medium h-9 items-center justify-center px-5 rounded-md text-white py-1 uk-modal-close">닫기</button>
                                                    </div>
                                                </th:block>


                                            </div>
                                        </div>
                                        <a href="timeline-page.html" class="bg-blue-600 flex flex-1 font-semibold h-10 items-center justify-center px-4 rounded-md text-white">
                                            찜
                                        </a>
                                    </div>
                                </th:block>
                            </div>
                            <div class="card p-6 relative">
                                <h3 class="mb-5 mt-2 font-semibold text-xl"> 댓글 작성하기 </h3>
                                <div class="bg-gray-100 rounded-full relative dark:bg-gray-800 border-b">
                                    <form id="reply_form" onsubmit="return false">
                                        <input type="hidden" id="r_board_id" name="r_board_id" class="form-control"
                                               value="1" th:value="${marketId}" readonly>
                                        <input type="hidden" id="r_account_id" name="r_account_id" class="form-control"
                                               value="1" th:value="${account.id}" readonly>
                                        <input type="text" id="r_content" placeholder="댓글을 입력해주세요." name="r_content" class="bg-transparent max-h-10 shadow-none px-5">
                                        <div class="-m-0.5 absolute bottom-0 flex items-center right-3 text-xl">
                                            <a class="write_reply">
                                                <ion-icon name="return-down-back-outline" class="hover:bg-gray-200 p-1.5 rounded-full"></ion-icon>
                                            </a>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="isDeletedForm">
                        <div id="isDeleted"></div>
                    </div>
                    <!-- 댓글 -->
                    <div class="card p-6">
                        <div class="reply_div">
                            <h1 class="block text-lg font-semibold mb-4">Comments (<a th:text="${reply.size()}"></a>)</h1>

                            <div class="space-y-5">

                                <div th:each="reply : ${reply}" class="flex gap-x-4 relative rounded-md">
                                    <img th:if="${#strings.isEmpty(reply.getAccount()?.profileImage)}"
                                         th:data-id="${reply.getAccount().studentId}"
                                         alt="" class="identicon rounded-full shadow w-12 h-12 is_avatar"/>
                                    <img th:if="${!#strings.isEmpty(reply.getAccount()?.profileImage)}"
                                         th:src="${reply.getAccount()?.profileImage}"
                                         alt="" class="rounded-full shadow w-12 h-12 is_avatar"/>
                                    <th:block th:if="${reply.getAccount().id == account.id}">
                                        <div class="absolute right-16 top-0 text-blue-500" uk-tooltip="댓글 수정" th:onclick="|updateBtn.replyUpdate(${reply.rid})|" th:id="|replyUpdateBtn${reply.rid}|">
                                            <a>
                                                <span>수정</span>
                                            </a>
                                        </div>
                                        <div class="absolute right-16 top-0 text-blue-500 updateSubmit" uk-tooltip="댓글 수정" th:onclick="|updateComplete.replyUpdateAjax(${reply.rid})|" th:id="|replyUpdateSubmit${reply.rid}|">
                                            <a>
                                                <span>등록</span>
                                            </a>
                                        </div>
                                        <div class="absolute right-5 top-0 text-red-500" uk-tooltip="댓글 삭제" th:onclick="|deleteReplyBtn.deleteReply(${reply.rid})|" th:id="|replyDeleteSubmit${reply.rid}|">
                                            <a>
                                                <span class="likes">삭제</span>
                                                <form onsubmit="return false" th:id="|replyDeleteForm${reply.rid}|" class="d-none">
                                                    <input type="hidden" th:value="${reply.rid}" name="reply_delete_rid">
                                                </form>
                                            </a>
                                        </div>
                                    </th:block>
                                    <th:block th:if="${reply.getAccount().id != account.id}">
                                        <div class="absolute right-5 top-0 text-red-500" uk-tooltip="댓글 신고">
                                            <a th:href="@{/reply/report/{replyId}(replyId = ${reply.rid})}">
                                                <span class="likes">신고</span>
                                            </a>
                                        </div>
                                    </th:block>
                                    <br>
                                    <!--<a href="#" class="bg-gray-100 py-1.5 px-4 rounded-full absolute right-5 top-0">Replay</a>-->
                                    <div>
                                        <a th:href="@{/profile/{nickname}(nickname=${reply.getAccount().nickname})}"><h4 class="text-base m-0 font-semibold" th:text="${reply.getAccount().nickname}">댓글 작성자</h4></a>
                                        <span class="text-gray-700 text-sm" th:text="${service.boardDateTime(reply.uploadTime)}"></span>
                                        <th:block th:if="${!reply.getIsReported}">
                                            <form onsubmit="return false" th:id="|replyUpdateForm${reply.rid}|">
                                                <input type="hidden" th:value="${reply.rid}" name="reply_update_rid">

                                                <p class="mt-3 md:ml-0 -ml-16" th:text="${reply.content}" th:id="|orginalReply${reply.rid}|">내용</p>
                                                <input type="hidden" th:value="${reply.content}" name="reply_update_content" th:id="|replyUpdateInput${reply.rid}|">
                                            </form>
                                        </th:block>
                                        <th:block th:if="${reply.getIsReported}">
                                            <p class="mt-3 md:ml-0 -ml-16">신고된 댓글입니다.</p>
                                        </th:block>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 수정 -->
                    <div id="offcanvas-create" uk-offcanvas="flip: true; overlay: true" style="margin-top: 0px">
                        <div class="uk-offcanvas-bar lg:w-4/12 w-full dark:bg-gray-700 dark:text-gray-300 p-0 bg-white shadow-2xl">

                            <button class="uk-offcanvas-close absolute" type="button" uk-close></button>

                            <!-- notivication header -->
                            <div class="-mb-1 border-b font-semibold px-5 py-5 text-lg">
                                <h4> 수정   </h4>
                            </div>
                            <form class="needs-validation space-y-4 g:w-8/12 market_form" id="market_form"
                                   enctype="multipart/form-data" method="post"
                                  th:action="@{'/market/detail/' + ${product.marketId} + '/update'}"
                                  th:object="${marketForm}" novalidate>
                                <div class="p-6 space-y-3 flex-1">
                                    <div>
                                        <label for="marketType"> 카테고리 </label>
                                        <select id="marketType" aria-describedby="marketTypeHelp" class="selectpicker with-border" th:filed="*{marketType}" th:value="${product.marketType}">
                                            <option value="판매" th:selected="${product.marketType}=='판매'" th:value="판매"> 판매 </option>
                                            <option value="구매" th:selected="${product.marketType}=='구매'" th:value="구매"> 구매 </option>
                                            <option value="나눔" th:selected="${product.marketType}=='나눔'" th:value="나눔"> 나눔 </option>
                                        </select>
                                        <small id="marketTypeHelp" class="form-text text-muted">
                                            어떤 방식의 상품을 등록할지 선택해주세요.
                                        </small>
                                        <small class="invalid-feedback">다시 선택해주세요.</small>
                                        <p class="form-text text-danger" th:if="${#fields.hasErrors('marketType')}"
                                           th:errors="*{marketType}">marketType Error</p>
                                    </div>
                                    <div>
                                        <label for="itemName"> 품명  </label>
                                        <input id="itemName"type="text" name="itemName"
                                               th:filed="*{itemName}"
                                               th:value="${product.itemName}"
                                               aria-describedby="itemNameHelp" required max="50"
                                               class="with-border" placeholder="">
                                        <small id="itemNameHelp" class="form-text text-muted">
                                            50자 이내로 적어주세요.
                                        </small>
                                        <small class="invalid-feedback">물건의 품명을 다시 확인해주세요.</small>
                                        <p class="form-text text-danger" th:if="${#fields.hasErrors('itemName')}"
                                           th:errors="*{itemName}">itemName Error</p>
                                    </div>
                                    <div>
                                        <label for="description"> 설명  </label>
                                        <textarea id="description" type="text" name="itemDetail"
                                                  th:filed="*{itemDetail}"
                                                  th:value="${product.itemDetail}" th:utext="${product.itemDetail}" rows="2" class="with-border w-full p-4"
                                                  placeholder="상품의 설명을 자세히 적어주세요." required max="250"></textarea>
                                        <small id="itemDetailHelp" class="form-text text-muted">
                                            상품의 설명은 250자 이내로 작성 가능합니다.
                                        </small>
                                        <small class="invalid-feedback">상품 설명을 다시 확인해주세요.</small>
                                        <p class="form-text text-danger" th:if="${#fields.hasErrors('itemDetail')}"
                                           th:errors="*{itemDetail}">itemDetail Error</p>
                                    </div>

                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label for="price" th:value="${product.price}"> 가격 </label>
                                            <input id="price"
                                                   th:value="${product.price}"
                                                   type="text" class="with-border w-full"
                                                   aria-describedby="priceHelp"
                                                   maxlength="10">
                                            <input type="hidden" id="priceNum" th:field="*{price}">
                                            <small id="priceHelp" class="form-text text-muted">
                                                숫자만 입력 가능하며, 그외에는 입력할시 입력창이 초기화됩니다.
                                            </small>
                                            <small class="invalid-feedback">숫자만 입력이 가능합니다.</small>
                                            <p class="form-text text-danger" th:if="${#fields.hasErrors('price')}"
                                               th:errors="*{price}">itemDetail Error</p>
                                        </div>
                                        <div>
                                            <label for="itemStatus"> 상품 상태 </label>
                                            <select id="itemStatus" name="itemStatus" class="selectpicker with-border"
                                                    th:filed="*{itemStatus}"
                                                    th:value="${product.itemStatus}"
                                                    aria-describedby="itemStatusHelp">
                                                <option value="새것" th:selected="${product.itemStatus}=='새것'" th:value="새것"> 새 것 </option>
                                                <option value="사용감있음" th:selected="${product.itemStatus}=='사용감있음'" th:value="사용감있음"> 사용감 있음 </option>
                                                <option value="사용감없음" th:selected="${product.itemStatus}=='사용감없음'" th:value="사용감없음"> 사용감 없음 </option>
                                            </select>
                                            <small id="itemStatusHelp" class="form-text text-muted">
                                                본인이 판매할 물건의 상태 혹은 구매하고 싶은 물건의 상태를 골라주세요
                                            </small>
                                            <small class="invalid-feedback">상품 상태를 다시 확인해주세요.</small>
                                            <p class="form-text text-danger" th:if="${#fields.hasErrors('itemStatus')}"
                                               th:errors="*{itemStatus}">itemDetail Error</p>
                                        </div>
                                    </div>
                                    <div uk-form-custom class="w-full py-3">
                                        <div class="bg-gray-100 border-2 border-dashed flex flex-col h-32 items-center justify-center relative w-full rounded-lg dark:bg-gray-800 dark:border-gray-600">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-12">
                                                <path d="M5.5 13a3.5 3.5 0 01-.369-6.98 4 4 0 117.753-1.977A4.5 4.5 0 1113.5 13H11V9.413l1.293 1.293a1 1 0 001.414-1.414l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13H5.5z" />
                                                <path d="M9 13h2v5a1 1 0 11-2 0v-5z" />
                                            </svg>
                                        </div>
                                        <input class="my-5" type="file" name="file" id="input-image" accept="image/png, image/jpeg">

                                        <img style="width: 500px;" id="preview-image" th:src="${product.filePath}">
                                        <input type="hidden" name="imageFile" id="imageFile">
                                    </div>
                                </div>
                                <div class="p-5">
                                    <button onclick="update_market()" type="submit"
                                            class="bg-blue-600 flex h-9 items-center justify-center rounded-md text-white px-5 font-medium">
                                        수정
                                    </button>
                                </div>
                            </form>


                        </div>
                    </div>
                </div>
                <div class="lg:w-72 w-full">
                </div>
            </div>
        </div>
    </div>
</div>

<script type="application/javascript" th:inline="javascript">
    function update_market() {
        let price = document.getElementById("price");
        let priceNum = document.getElementById("priceNum");

        priceNum.value = price.value;

        $("#market_form").submit();
    }

    const input = document.querySelector('#price');      //[1]
    input.addEventListener('keyup', function(e) {
        let value = e.target.value;
        value = Number(value.replaceAll(',', ''));
        if(isNaN(value)) {         //NaN인지 판별
            input.value = 0;
        }else {                   //NaN이 아닌 경우
            const formatValue = value.toLocaleString('ko-KR');
            input.value = formatValue;
        }
    })
        /*    function marketUpdate() {
                console.log("market Update 실행");
                console.log('/market/detail/'+ [[${product.marketId}]] +'/update')
                $.ajax({
                    url:'/market/detail/'+ [[${product.marketId}]] +'/update',
                    type:'get',
                    enctype: 'multipart/form-data',	// 필수
                    data: {marketType: "marketType", itemName: "itemName", itemDetail: "itemDetail", price: "price", itemStatus: "itemStatus", imageFile: "imageFile" },		// 필수
                    processData: false,	// 필수
                    contentType: false,
                    // data : $('#board_form').serialize(),
                    success : function (){
                        location.reload();
                    },
                });
            }*/

    function readImage(input) {

        let maxSize = 5 * 1024 * 1024; //2MB
        let size = input.files[0].size;
        console.log(size);
        if(size > maxSize){
            alert("이미지 용량은 5MB 이내로 등록 가능합니다. ");
            return;
        }

        // 인풋 태그에 파일이 있는 경우
        if(input.files && input.files[0]) {
            // 이미지 파일인지 검사 (생략)
            let imageFile = $("#imageFile");
            imageFile.val("checked");
            console.log(imageFile);

            // FileReader 인스턴스 생성
            const reader = new FileReader()
            // 이미지가 로드가 된 경우
            reader.onload = e => {
                const previewImage = document.getElementById("preview-image")
                previewImage.src = e.target.result
            }
            // reader가 이미지 읽도록 하기
            reader.readAsDataURL(input.files[0])
        }
    }
    // input file에 change 이벤트 부여
    const inputImage = document.getElementById("input-image")
    inputImage.addEventListener("change", e => {
        readImage(e.target)
    })
    /*상품 상태 변경 시작*/
    function marketTypeSell() {
        /*<![CDATA[*/
        var path = [[${product.marketId}]];
        /*]]>*/
        swal({
            title: "상품 상태 변경.",
            text: "상품의 상태를 판매중으로 변경하시겠습니까?",
            icon: "info",
            buttons: true,
            dangerMode: true,
        })
        .then((willDelete) => {
            console.log("willdelete");
            $.ajax({
                url: '/market/detail/' + path + '/type/selling',
                type: 'GET',
                contentType: "application/x-www-form-urlencoded; charset=utf-8",
                success: function (message) {
                    location.reload();
                    $("#isUpdatedForm").html('<div id="isUpdated"></div>');
                    $("#isUpdated").replaceWith(message);
                },
            })
        });
    }

    function marketTypeEnd() {
        /*<![CDATA[*/
        var path = [[${product.marketId}]];
        /*]]>*/

        swal({
            title: "상품 상태 변경.",
            text: "상품의 상태를 판매완료로 변경하시겠습니까?",
            icon: "info",
            buttons: true,
            dangerMode: true,
        })
            .then((willDelete) => {
                console.log("willdelete");
                $.ajax({
                    url: '/market/detail/' + path + '/type/sold-out',
                    type: 'GET',
                    contentType: "application/x-www-form-urlencoded; charset=utf-8",
                    success: function (message) {
                        location.reload();
                        $("#isUpdatedForm").html('<div id="isUpdated"></div>');
                        $("#isUpdated").replaceWith(message);
                    },
                })
            });
    }
    /*상품 상태 변경 끝*/

    var imageDelay = (function (){
        var timer = 0;
        return function (callback, ms) {
            clearTimeout(timer);
            timer = setTimeout(callback, ms);
        };
    })();
    // 수정 버튼 클릭 시
    let updateBtn = {
        replyUpdate: function (replyId) {
            jQuery(`#orginalReply${replyId}`).hide();
            jQuery(`#replyUpdateBtn${replyId}`).hide();
            jQuery(`#replyUpdateSubmit${replyId}`).show();
            $(`#replyUpdateInput${replyId}`).prop("type", "text");
            $(`#replyUpdateInput${replyId}`).css("background-color", "rgb(229 231 235)");
        }
    }
    // 등록 버튼 클릭 시
    let updateComplete = {
        replyUpdateAjax: function (replyId) {
            console.log(`${replyId}`);
            // 댓글 수정 ajax
            console.log("댓글 수정");
            $.ajax({
                url:'/reply/update',
                type:'get',
                contentType: "application/x-www-form-urlencoded; charset=utf-8",
                data : $(`#replyUpdateForm${replyId}`).serialize(),
                dataType : "json",
                success : function (){
                    $('.reply_div').load(location.href+' .reply_div');
                    jQuery(`#orginalReply${replyId}`).show();
                    jQuery(`#replyUpdateBtn${replyId}`).show();
                    jQuery(`#replyUpdateSubmit${replyId}`).hide();
                    $(`#replyUpdateInput${replyId}`).prop("type", "hidden");
                },
                error : function (request, status, error){
                    console.log("Reply Update Fail" + error);
                }
            });
            imageDelay(function (){
                $(".identicon").each(function() {
                    var hash = md5($(this).data('id')).toString();
                    var data = new Identicon(hash,{format:'svg'}).toString();
                    $(this).attr('src', "data:image/svg+xml;base64,"+data);
                });
            }, 1000);
        }
    }
    // 댓글 삭제
    let deleteReplyBtn = {
        deleteReply: function (replyId) {
            swal({
                title: "댓글을 삭제하시겠습니까?",
                text: "삭제된 댓글은 복구할 수 없습니다.",
                icon: "warning",
                buttons: true,
                dangerMode: true,
            })
                .then((willDelete) => {
                    window.addEventListener('keydown', function (e){
                        if (e.keyCode == 13) {
                            swal("엔터키는 사용할 수 없습니다.");
                        }
                    })
                    if (willDelete) {
                        $.ajax({
                            url:'/reply/delete',
                            type:'get',
                            contentType: "application/x-www-form-urlencoded; charset=utf-8",
                            data : $(`#replyDeleteForm${replyId}`).serialize(),
                            //dataType : "json",
                            success : function (r_del_message){
                                $('.reply_div').load(location.href+' .reply_div');
                                $("#isDeletedForm").html('<div id="isDeleted"></div>');
                                $("#isDeleted").replaceWith(r_del_message);
                            },
                        });
                        imageDelay(function (){
                            $(".identicon").each(function() {
                                var hash = md5($(this).data('id')).toString();
                                var data = new Identicon(hash,{format:'svg'}).toString();
                                $(this).attr('src', "data:image/svg+xml;base64,"+data);
                            });
                        }, 1000);
                    } else {
                        swal("댓글이 삭제되지 않았습니다. 다시 시도해주세요.");
                    }
                });

        }
    }
    $(document).ready(function () {
        // Delay 함수
        var delay = (function (){
            var timer = 0;
            return function (callback, ms) {
                clearTimeout(timer);
                timer = setTimeout(callback, ms);
            };
        })();

        $('#description').summernote({
            placeholder: '글의 내용을 입력해주세요.<br/>타인에게 불쾌감을 주는 글은 예고없이 삭제됩니다.<br/>또한 신고가 누적될 시 제재가 있을 수 있습니다.',
            tabsize: 2,
            toolbar: [
                ['font', ['bold', 'italic', 'underline', 'clear']],
            ],
            maxHeight: null,
            minHeight: null,
            lang: 'ko-KR',
            height: 500,
        });
        // input에 있는 값을 가져옴
        var keydown = true;
        var input = document.getElementById("r_content");
        input.addEventListener('keypress', function (key) {
            if (input.value == '' && key.key == 'Enter') {
                alert("댓글을 입력해주세요.");
            }
            if (input.value != '' && key.key == 'Enter') {
                $.ajax({
                    url: '/market/reply',
                    type: 'get',
                    contentType: "application/x-www-form-urlencoded; charset=utf-8",
                    data: $('#reply_form').serialize(),
                    dataType: "json",
                    success: function () {
                        console.log("Write Reply Success");
                        $('.reply_div').load(location.href + ' .reply_div');
                        input.value = '';
                        keydown = false;
                        $(input).attr("readonly",true);
                        $(input).attr("placeholder","5초 뒤에 댓글을 입력할 수 있습니다.");
                    },
                    error: function (request, status, error) {
                        console.log("Write Reply Fail" + error);
                    }
                });
            }
            imageDelay(function (){
                $(".identicon").each(function() {
                    var hash = md5($(this).data('id')).toString();
                    var data = new Identicon(hash,{format:'svg'}).toString();
                    $(this).attr('src', "data:image/svg+xml;base64,"+data);
                });
            }, 1000);

            delay(function (){
                $(input).removeAttr("readonly");
                $(input).attr("placeholder","댓글을 입력해주세요.");
                keydown=true;
            }, 5000);
        });
        $(document).on('click', '.write_reply', function () {
            if (input.value == '') {
                alert("댓글을 입력해주세요.");
            }
            if (input.value != '') {
                console.log("댓글 작성");
                $.ajax({
                    url: '/market/reply',
                    type: 'get',
                    contentType: "application/x-www-form-urlencoded; charset=utf-8",
                    data: $('#reply_form').serialize(),
                    dataType: "json",
                    success: function () {
                        console.log("Write Reply Success");
                        $('.reply_div').load(location.href + ' .reply_div');
                        input.value = '';
                        keydown = false;
                        $(input).attr("readonly",true);
                        $(input).attr("placeholder","5초 뒤에 댓글을 입력할 수 있습니다.");
                    },
                    error: function (request, status, error) {
                        console.log("Write Reply Fail" + error);
                    }
                });
            }
            imageDelay(function (){
                $(".identicon").each(function() {
                    var hash = md5($(this).data('id')).toString();
                    var data = new Identicon(hash,{format:'svg'}).toString();
                    $(this).attr('src', "data:image/svg+xml;base64,"+data);
                });
            }, 1000);

            delay(function (){
                $(input).removeAttr("readonly");
                $(input).attr("placeholder","댓글을 입력해주세요.");
                keydown=true;
            }, 5000);
        });
        var reply_input = document.getElementById("reply_update_content");
        $(document).on('click', '#update_reply', function () {
            if (reply_input.value == '') {
                alert("댓글을 입력해주세요.");
            }
            if (reply_input.value != '') {
                console.log("댓글 수정");
                $.ajax({
                    url: '/market/reply/update',
                    type: 'get',
                    contentType: "application/x-www-form-urlencoded; charset=utf-8",
                    data: $('#reply_update_form').serialize(),
                    dataType: "json",
                    success: function () {
                        console.log("Reply Update Success");
                        $('.reply_div').load(location.href + ' .reply_div');
                        $('#reply_update_form').load(location.href + ' #reply_update_form');
                    },

                    error: function (request, status, error) {
                        console.log("Reply Update Fail" + error);
                    }
                });
            }
            imageDelay(function (){
                $(".identicon").each(function() {
                    var hash = md5($(this).data('id')).toString();
                    var data = new Identicon(hash,{format:'svg'}).toString();
                    $(this).attr('src', "data:image/svg+xml;base64,"+data);
                });
            }, 1000);
        });


        var c_textarea = $('#c_content');
        $(document).on('click', '.chat_send', function () {
            if (c_textarea.val().length < 2) {
                swal("5글자 이상의 내용을 입력해주세요.", {
                    icon: "warning",
                });
                c_textarea.val('');
            }
            if (c_textarea.val().length >= 2) {
                console.log("쪽지 보내기");
                $.ajax({
                    url: '/chat/new',
                    type: 'get',
                    contentType: "application/x-www-form-urlencoded; charset=utf-8",
                    data: $('#chat_form').serialize(),
                    success: function (sendChat) {
                        console.log("쪽지 성공");
                        $('.form_refresh').load(window.location.href+' .form_refresh');
                        c_textarea.value = '';
                        $("#isUpdatedForm").html('<div id="isUpdated"></div>');
                        $("#isUpdated").replaceWith(sendChat);
                    },
                    error: function (request, status, error) {
                        console.log("쪽지 실패" + error);
                    }
                });
                imageDelay(function (){
                    $(".identicon").each(function() {
                        var hash = md5($(this).data('id')).toString();
                        var data = new Identicon(hash,{format:'svg'}).toString();
                        $(this).attr('src', "data:image/svg+xml;base64,"+data);
                    });
                }, 1000);
            }
        });
    })
</script>
</body>
</html>
